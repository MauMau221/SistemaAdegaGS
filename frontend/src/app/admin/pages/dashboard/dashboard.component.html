<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando dashboard...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && summary" class="dashboard-content">
    <!-- Header com botão de atualizar -->
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <button mat-icon-button (click)="refresh()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards">
      <!-- Vendas -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="card-header">
            <mat-icon color="primary">payments</mat-icon>
            <h2>Vendas</h2>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="label">Hoje</span>
              <span class="value">{{summary ? formatCurrency(summary.sales.today) : 'R$ 0,00'}}</span>
            </div>
            <div class="stat">
              <span class="label">Este Mês</span>
              <span class="value">{{summary ? formatCurrency(summary.sales.month) : 'R$ 0,00'}}</span>
            </div>
            <div class="stat">
              <span class="label">Ticket Médio</span>
              <span class="value">{{summary ? formatCurrency(summary.sales.average_ticket) : 'R$ 0,00'}}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Pedidos -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="card-header">
            <mat-icon color="accent">shopping_cart</mat-icon>
            <h2>Pedidos</h2>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="label">Pendentes</span>
              <span class="value" [style.color]="getStatusColor(summary ? summary.orders.pending : 0, 5)">
                {{summary ? summary.orders.pending : 0}}
              </span>
            </div>
            <div class="stat">
              <span class="label">Em Entrega</span>
              <span class="value">{{summary ? summary.orders.delivering : 0}}</span>
            </div>
            <div class="stat">
              <span class="label">Concluídos</span>
              <span class="value">{{summary ? summary.orders.completed : 0}}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Estoque -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="card-header">
            <mat-icon color="warn">inventory</mat-icon>
            <h2>Estoque</h2>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="label">Produtos</span>
              <span class="value">{{summary ? summary.stock.total_products : 0}}</span>
            </div>
            <div class="stat">
              <span class="label">Estoque Baixo</span>
              <span class="value" [style.color]="getStatusColor(summary ? summary.stock.low_stock_count : 0, 10)">
                {{summary ? summary.stock.low_stock_count : 0}}
              </span>
            </div>
            <div class="stat">
              <span class="label">Valor Total</span>
              <span class="value">{{summary ? formatCurrency(summary.stock.total_value) : 'R$ 0,00'}}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Usuários -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="card-header">
            <mat-icon>people</mat-icon>
            <h2>Usuários</h2>
          </div>
          <div class="card-stats">
            <div class="stat">
              <span class="label">Total</span>
              <span class="value">{{summary ? summary.users.total : 0}}</span>
            </div>
            <div class="stat">
              <span class="label">Novos (Mês)</span>
              <span class="value">{{summary ? summary.users.new_this_month : 0}}</span>
            </div>
            <div class="stat">
              <span class="label">Clientes</span>
              <span class="value">{{summary ? summary.users.customers : 0}}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Gráfico de Vendas (temporariamente desabilitado) -->
    <!--
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Vendas do Mês</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas baseChart
          [data]="salesChartData"
          [options]="salesChartOptions"
          type="line">
        </canvas>
      </mat-card-content>
    </mat-card>
    -->

    <!-- Top Products e Customers -->
    <div class="dashboard-tables">
      <!-- Top Products -->
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Produtos Mais Vendidos</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="topProducts">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Produto</th>
              <td mat-cell *matCellDef="let product">{{product.name}}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Qtd. Vendida</th>
              <td mat-cell *matCellDef="let product">{{product.quantity_sold}}</td>
            </ng-container>

            <ng-container matColumnDef="revenue">
              <th mat-header-cell *matHeaderCellDef>Receita</th>
              <td mat-cell *matCellDef="let product">{{formatCurrency(product.total_revenue)}}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'quantity', 'revenue']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['name', 'quantity', 'revenue'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- Top Customers -->
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Melhores Clientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="topCustomers">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Cliente</th>
              <td mat-cell *matCellDef="let customer">{{customer.name}}</td>
            </ng-container>

            <ng-container matColumnDef="orders">
              <th mat-header-cell *matHeaderCellDef>Pedidos</th>
              <td mat-cell *matCellDef="let customer">{{customer.orders_count}}</td>
            </ng-container>

            <ng-container matColumnDef="spent">
              <th mat-header-cell *matHeaderCellDef>Total Gasto</th>
              <td mat-cell *matCellDef="let customer">{{formatCurrency(customer.total_spent)}}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'orders', 'spent']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['name', 'orders', 'spent'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
