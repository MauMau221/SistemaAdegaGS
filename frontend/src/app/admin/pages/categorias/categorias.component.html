<div class="categorias-container">
  <div class="categorias-header">
    <h1>Categorias</h1>
    <div class="header-actions">
      <button mat-button
              [color]="viewMode === 'tree' ? 'accent' : ''"
              (click)="toggleViewMode()">
        <mat-icon>{{viewMode === 'list' ? 'account_tree' : 'list'}}</mat-icon>
        {{viewMode === 'list' ? 'Visualização em Árvore' : 'Visualização em Lista'}}
      </button>

      <button mat-raised-button 
              color="accent" 
              (click)="openCategoryDialog()">
        <mat-icon>add</mat-icon>
        Nova Categoria
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar categorias</mat-label>
          <input matInput
                 [(ngModel)]="searchTerm"
                 (keyup)="onSearch($event)"
                 placeholder="Nome ou descrição">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="viewMode === 'list'">
          <mat-label>Categoria Pai</mat-label>
          <mat-select [(ngModel)]="selectedParent" (selectionChange)="onParentChange()">
            <mat-option [value]="null">Todas</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category.id">
              {{category.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="filter-toggles">
          <mat-chip-listbox>
            <mat-chip-option
              [selected]="showInactive"
              (selectionChange)="toggleFilters('inactive')">
              Mostrar Inativas
            </mat-chip-option>
          </mat-chip-listbox>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando categorias...</p>
  </div>

  <!-- Visualização em Lista -->
  <mat-card *ngIf="!loading && viewMode === 'list'" class="table-card">
    <mat-card-content>
      <table mat-table 
             [dataSource]="categories" 
             matSort 
             (matSortChange)="onSortChange($event)"
             cdkDropList
             (cdkDropListDropped)="onDrop($event)">
        
        <!-- Imagem -->
        <ng-container matColumnDef="image">
          <th mat-header-cell *matHeaderCellDef>Imagem</th>
          <td mat-cell *matCellDef="let category">
            <div class="category-image">
              <img [src]="getImageUrl(category.image_url)"
                   [alt]="category.name"
                   width="40"
                   height="40">
            </div>
          </td>
        </ng-container>

        <!-- Nome -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nome</th>
          <td mat-cell *matCellDef="let category">
            <div class="category-name">
              {{category.name}}
              <small class="category-slug">{{category.slug}}</small>
            </div>
          </td>
        </ng-container>

        <!-- Categoria Pai -->
        <ng-container matColumnDef="parent">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoria Pai</th>
          <td mat-cell *matCellDef="let category">
            {{category.parent?.name || '-'}}
          </td>
        </ng-container>

        <!-- Produtos -->
        <ng-container matColumnDef="products_count">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Produtos</th>
          <td mat-cell *matCellDef="let category">
            <button mat-button
                    color="primary"
                    (click)="showStats(category)">
              {{category.products_count}}
            </button>
          </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let category">
            <mat-chip [color]="category.is_active ? 'primary' : 'warn'" selected>
              {{category.is_active ? 'Ativa' : 'Inativa'}}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Ações -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Ações</th>
          <td mat-cell *matCellDef="let category">
            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Ações">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openCategoryDialog(category)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item [matMenuTriggerFor]="moveMenu">
                <mat-icon>drive_file_move</mat-icon>
                <span>Mover para</span>
              </button>
              <button mat-menu-item (click)="toggleStatus(category)">
                <mat-icon>{{category.is_active ? 'visibility_off' : 'visibility'}}</mat-icon>
                <span>{{category.is_active ? 'Desativar' : 'Ativar'}}</span>
              </button>
              <button mat-menu-item (click)="deleteCategory(category)" color="warn">
                <mat-icon>delete</mat-icon>
                <span>Excluir</span>
              </button>
            </mat-menu>

            <!-- Submenu de Mover -->
            <mat-menu #moveMenu="matMenu">
              <button mat-menu-item (click)="moveCategory(category, null)">
                <mat-icon>home</mat-icon>
                <span>Raiz</span>
              </button>
              <button mat-menu-item *ngFor="let cat of categories"
                      [disabled]="cat.id === category.id"
                      (click)="moveCategory(category, cat.id)">
                {{cat.name}}
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            cdkDrag
            [cdkDragDisabled]="viewMode !== 'list'"></tr>
      </table>

      <!-- Empty State -->
      <div *ngIf="categories.length === 0" class="empty-state">
        <mat-icon>category</mat-icon>
        <p>Nenhuma categoria encontrada</p>
      </div>

      <!-- Paginação -->
      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageIndex]="currentPage"
        [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)">
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- Visualização em Árvore -->
  <mat-card *ngIf="!loading && viewMode === 'tree'" class="tree-card">
    <mat-card-content>
      <mat-tree [dataSource]="categoryTree" [treeControl]="treeControl">
        <!-- Nó com Filhos -->
        <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
          <button mat-icon-button matTreeNodeToggle>
            <mat-icon>
              {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
            </mat-icon>
          </button>
          <span class="tree-node-content">
            {{node.name}}
            <small>({{node.products_count}} produtos)</small>
          </span>
          <button mat-icon-button [matMenuTriggerFor]="treeMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #treeMenu="matMenu">
            <button mat-menu-item (click)="openCategoryDialog(node)">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="showStats(node)">
              <mat-icon>analytics</mat-icon>
              <span>Estatísticas</span>
            </button>
            <button mat-menu-item (click)="openCategoryDialog(undefined, node.id)">
              <mat-icon>add</mat-icon>
              <span>Adicionar Subcategoria</span>
            </button>
          </mat-menu>
        </mat-tree-node>

        <!-- Nó sem Filhos -->
        <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
          <button mat-icon-button disabled></button>
          <span class="tree-node-content">
            {{node.name}}
            <small>({{node.products_count}} produtos)</small>
          </span>
          <button mat-icon-button [matMenuTriggerFor]="treeMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #treeMenu="matMenu">
            <button mat-menu-item (click)="openCategoryDialog(node)">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="showStats(node)">
              <mat-icon>analytics</mat-icon>
              <span>Estatísticas</span>
            </button>
          </mat-menu>
        </mat-tree-node>
      </mat-tree>

      <!-- Empty State -->
      <div *ngIf="categoryTree.length === 0" class="empty-state">
        <mat-icon>account_tree</mat-icon>
        <p>Nenhuma categoria encontrada</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
